# Automatic Website Deployment via GitHub Actions + Webhook

## Introduction

The scenario of this deployment automation is a server hosting a website
generated by the static-site generator [Next.js](https://nextjs.org). The
sources are hosted on GitHub. Whenever the sources are updated on GitHub,
the website is built via a GitHub Actions workflow and the static files are
deployed on the webserver.

The setup described here is used for <https://www.cryptool.org/>.

> **Note:** While the workflows are specifically tailored to a Next.js project,
> the webhook is framework agnostic and can deploy the generated artifact of
> any static-site generator.


## Process Overview

The sources of the website are hosted in a GitHub repository. The repository
contains a GitHub Actions workflow to build the static site and upload the
generated site as a release asset. This workflow is triggered by a push. After
uploading, the workflow triggers a GitHub Deployment event. The repository is
configured to call a webhook on `deployment_status` events.

The webhook is implemented on the webserver as a Python script which reads a
configuration file that contains the local repository and deployment target
location for one or more repositories.

If the deployment request is valid, then a deployment script is called with the
configured parameters and the committer's email address. The script is also
implemented as a Python script. It performs the following steps:

1. Set the deployment status to `in_progress` on GitHub
1. Download the associated release asset, and extract it to a uniquely named
   directory next to the symlink
1. Remove the downloaded asset
1. Replace the symlink atomically with a link to new HTML directory
1. Remove old HTML directory
1. Set deployment status to `success` on GitHub
1. Send the logs to configured maintainers and the committer


## GitHub Configuration

### Workflows

Copy the [`development.yml`](./workflows/development.yml) and
[`release.yml`](./workflows/release.yml) workflow definitions into your GitHub
repository at `.github/workflows`.

In [`development.yml`](./workflows/development.yml), adjust the branches that
trigger a deployment and configure the environment variables `SHOULD_DEPLOY` to
your repository name and `DEPLOY_(ENVIRONMENT|URL)` and your environment names
and urls.

> **Note:** These are specifically tailored to a Next.js project, but should be
> easily adjusted to other `npm` compatible static-site generators.

### Webhook

In the GitHub repository `Settings` select `Webhooks` and `Add webhook` and
enter the following parameters:

`Payload URL:` https://example.com/deploy

> **Note:** The URL needs to match the ScriptAlias in the
> [Webserver Configuration](#webserver-configuration) above.

`Content type: application/json`

`Secret:` random-value

> **Note:** The secret needs to match the value configured in
> `/etc/deploywebhookgithub.json`

`SSL verification:` Select `Enable SSL verifcation`

`Which events would you like to trigger this webhook?` Select `Let me select
individual events.` and enable `Deployment statuses`

### Secrets

In the GitHub repository `Settings` select `Secrets and Variables > Actions`
and `New repository secret` and enter the following parameters:

`Name:` DEPLOYMENT_KEY

`Secret:` random-value

> **Note:** The secret needs to match the value configured for the Webhook
> and in `/etc/deploywebhookgithub.json`

### Personal Access Token

**TODO**
