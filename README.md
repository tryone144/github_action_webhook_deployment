# Automatic Website Deployment via GitHub Actions + Webhook

## Introduction

The scenario of this deployment automation is a server hosting a website
generated by the static-site generator [Next.js](https://nextjs.org). The
sources are hosted on GitHub. Whenever the sources are updated on GitHub,
the website is built via a GitHub Actions workflow and the static files are
deployed on the webserver.

The setup described here is used for <https://www.cryptool.org/>.

> **Note:** While the workflows are specifically tailored to a Next.js project,
> the webhook is framework agnostic and can deploy the generated artifact of
> any static-site generator.


## Process Overview

The sources of the website are hosted in a GitHub repository. The repository
contains a GitHub Actions workflow to build the static site and upload the
generated site as a release asset. This workflow is triggered by a push. After
uploading, the workflow triggers a GitHub Deployment event. The repository is
configured to call a webhook on `deployment_status` events.

The webhook is implemented on the webserver as a Python script which reads a
configuration file that contains the local repository and deployment target
location for one or more repositories.

If the deployment request is valid, then a deployment script is called with the
configured parameters and the committer's email address. The script is also
implemented as a Python script. It performs the following steps:

1. Set the deployment status to `in_progress` on GitHub
1. Download the associated release asset, and extract it to a uniquely named
   directory next to the symlink
1. Remove the downloaded asset
1. Replace the symlink atomically with a link to new HTML directory
1. Remove old HTML directory
1. Set deployment status to `success` on GitHub
1. Send the logs to configured maintainers and the committer


## Webserver Configuration

All configuration shown here is for Apache 2.4.

### Webhook

Configure the Python script implementing the webhook in a suitable virtual host
or globally by using this sample
[config](etc/apache2/conf-available/deploywebhookgithub.conf). We assume the
virtual host `example.com` here.

```apache
ScriptAlias /deploy /usr/local/sbin/deploywebhookgithub
<Location /deploy>
    Require all granted
</Location>
```

Create the configuration file for the webhook in
[`/etc/deploywebhookgithub.json`](etc/deploywebhookgithub.json):

```json
{
  "deploy_user": "deploy_website",
  "log_recipients": ["admin@example.com"],
  "repositories": {
    "githubuser/repository": {
      "signature_key": "<random key created with: openssl rand -base64 32>",
      "access_token": "<personal access token with read access to code and metadata + read/write to deployments",
      "log_recipients": ["maintainer@example.com"],
      "environments": {
        "production": {
          "deploy_url": "https://www.example.com/",
          "html_symlink": "/var/www/example.com/root"
        }
      }
    }
  }
}
```

Set permissions to allow the webserver to read the file.
```console
$ sudo chmod 640 /etc/deploywebhookgithub.json
$ sudo chown root:www-data /etc/deploywebhookgithub.json
```

The configuration contains two three-level keys:

1. `deploy_user`: A special user to run the `deploy_website` script via
   `sudo`. This can be configured with more restrictive permissions.
1. `log_recipients` (optional): A list of email addresses to receive the log
   messages for all deployments.

You can configure multiple GitHub repositories in `repositories`. The example
above includes a single repository: `githubuser/repository`.

For each repository the configuration contains four keys:

1. `signature_key`: A random key used to authenticate GitHub to the webhook
   script. The key needs to be configured in the GitHub webhook configuration,
   as well (see [below](#github-configuration)).
1. `access_tocken`: A personal access token to authenticate the deployment
   script to the GitHub API. This token needs to be generated with *read
   access* to the repositories code and metadata as well as with *read+write*
   to the deployment (see [below](#github-configuration)).
1. `log_recipients` (optional): A list of email addresses to receive the log
   messages for each deployment of this repository.

Each repository has a separate entry for the deployment environment. The
example contains only one environment: `production`.

For each repository and environment the configuration contains three keys:

1. `deploy_url`: The public facing URL to the deployment of this environment.
1. `html_symlink`: The symlink pointing to HTML root directory of the website.
   The symlink needs to be configured in the web server as the document root
   and will be replaced by `deploy_website` with a new directory containing the
   generated static-site output.
1. `log_recipients` (optional): A list of email addresses to receive the log
   messages for each deployment in this specific environment.

### Website

The virtual host of the website example.com needs to be configured with
`html_symlink` (see above) as document root.

```apache
DocumentRoot "/var/www/example.com/root"
```


## Unix Configuration

### Install Scripts

```console
$ sudo install --owner=root --group=root bin/deploywebhookgithub bin/deploy_website /usr/local/sbin
```

### Deployment User

The deployment script `deploy_website` is run as user `deploy_website` via
`sudo` from `deploywebhookgithub`. The user can be configured in
`/etc/deploywebhookgithub.json` with `deploy_user`.

Using a different user than the webserver user `www-data` makes the static
website read-only for the webserver.

```console
$ sudo adduser --system --ingroup www-data --disabled-password --gecos 'User for deploying websites via github webhook' deploy_website
```

### Sudo Configuration

To allow the webserver to run the `deploy_website` script as the user with the
same name, create the file [`/etc/sudoers.d/deploy_website`](etc/sudoers.d/deploy_website)
with the following content:

```sudo
Cmnd_Alias DEPLOYCMD = \
        /usr/local/sbin/deploy_website /var/www/example.com/root githubuser/repository production *
Defaults!DEPLOYCMD env_keep+="GITHUB_TOKEN SIGNATURE_KEY"
%www-data       ALL=(deploy_website)NOPASSWD: DEPLOYCMD
```

The paths of the HTML root, repository name and environment must match the
webhook configuration in `/etc/deploywebhookgithub.json`. Multiple
paths/repositories/environments can be configured as required. The wildcard at
the end of the command is required for passing the email addresses.


## GitHub Configuration

### Workflows

Copy the [`development.yml`](./workflows/development.yml) and
[`release.yml`](./workflows/release.yml) workflow definitions into your GitHub
repository at `.github/workflows`.

In [`development.yml`](./workflows/development.yml), adjust the branches that
trigger a deployment and configure the environment variables `SHOULD_DEPLOY` to
your repository name and `DEPLOY_(ENVIRONMENT|URL)` and your environment names
and urls.

> **Note:** These are specifically tailored to a Next.js project, but should be
> easily adjusted to other `npm` compatible static-site generators.

### Webhook

In the GitHub repository `Settings` select `Webhooks` and `Add webhook` and
enter the following parameters:

`Payload URL:` https://example.com/deploy

> **Note:** The URL needs to match the ScriptAlias in the
> [Webserver Configuration](#webserver-configuration) above.

`Content type: application/json`

`Secret:` random-value

> **Note:** The secret needs to match the value configured in
> `/etc/deploywebhookgithub.json`

`SSL verification:` Select `Enable SSL verifcation`

`Which events would you like to trigger this webhook?` Select `Let me select
individual events.` and enable `Deployment statuses`

### Secrets

In the GitHub repository `Settings` select `Secrets and Variables > Actions`
and `New repository secret` and enter the following parameters:

`Name:` DEPLOYMENT_KEY

`Secret:` random-value

> **Note:** The secret needs to match the value configured for the Webhook
> and in `/etc/deploywebhookgithub.json`

### Personal Access Token

**TODO**
